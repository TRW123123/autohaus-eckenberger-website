---
import { DEMO_CARS as cars } from "../lib/inventory";
// Show up to 8 featured cars in the 3D carousel
const featured = cars.slice(0, 8);
---

<section class="py-16 md:py-24 bg-navy overflow-hidden">
    <div class="container mx-auto px-6 mb-10 text-center">
        <span
            class="text-orange tracking-widest text-sm font-bold uppercase block mb-2"
        >
            Innovation & Zuverlässigkeit
        </span>
        <h2 class="text-4xl md:text-6xl font-black text-white uppercase mb-4">
            PREMIUM <br /><span class="text-orange">FAHRZEUGE</span>
        </h2>
        <p class="text-lg text-cream/80 max-w-2xl mx-auto">
            Ihr Boutique-Partner für exzellente Sprinter, Transporter und
            handverlesene PKW.
        </p>
    </div>

    <!-- 3D Carousel Container -->
    <div class="relative max-w-[1400px] mx-auto" id="carousel-wrap">
        <!-- Navigation Arrows -->
        <button
            id="carousel-prev"
            class="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 z-30 w-12 h-12 bg-charcoal/80 backdrop-blur-sm border border-navy flex items-center justify-center text-white hover:bg-orange/20 hover:border-orange hover:text-orange transition-all duration-300 rounded-full cursor-pointer"
            aria-label="Vorheriges Fahrzeug"
        >
            <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>
        <button
            id="carousel-next"
            class="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 z-30 w-12 h-12 bg-charcoal/80 backdrop-blur-sm border border-navy flex items-center justify-center text-white hover:bg-orange/20 hover:border-orange hover:text-orange transition-all duration-300 rounded-full cursor-pointer"
            aria-label="Nächstes Fahrzeug"
        >
            <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

        <!-- 3D Stage -->
        <div class="carousel-stage" id="carousel-stage">
            {
                featured.map((car, i) => (
                    <a
                        href={`/fahrzeug/${car.id}`}
                        class="carousel-slide"
                        data-index={i}
                    >
                        <div class="carousel-card rounded-xl">
                            <div class="aspect-[4/3] bg-charcoal overflow-hidden relative rounded-t-xl">
                                <img
                                    src={car.images[0]}
                                    alt={`${car.make} ${car.model}`}
                                    class="w-full h-full object-cover"
                                    loading="lazy"
                                />
                                <div class="absolute inset-0 bg-gradient-to-t from-charcoal via-transparent to-transparent opacity-90" />
                            </div>

                            <div class="p-6">
                                <div class="flex flex-col gap-1 mb-3">
                                    <h3 class="text-lg font-black text-white uppercase leading-tight line-clamp-1">
                                        {car.make}{" "}
                                        <span class="text-cream/80 font-bold">
                                            {car.model}
                                        </span>
                                    </h3>
                                    <div class="text-xl font-black text-orange">
                                        {car.price.toLocaleString("de-DE")} €
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 text-xs font-mono text-cream/70 mt-2">
                                    <span>{car.firstRegistration}</span>
                                    <span class="text-navy">|</span>
                                    <span>
                                        {car.mileage.toLocaleString("de-DE")} km
                                    </span>
                                    <span class="text-navy">|</span>
                                    <span>
                                        {car.power} {car.powerUnit}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>
                ))
            }
        </div>

        <!-- Dot Indicators -->
        <div class="flex justify-center gap-2 mt-8" id="carousel-dots">
            {
                featured.map((_, i) => (
                    <button
                        class="carousel-dot w-2 h-2 rounded-full bg-charcoal transition-all duration-300 cursor-pointer border border-navy"
                        data-dot={i}
                        aria-label={`Gehe zu Slide ${i + 1}`}
                    />
                ))
            }
        </div>
    </div>

    <!-- CTA -->
    <div class="text-center mt-12">
        <a
            href="/fahrzeugbestand"
            class="inline-flex items-center gap-2 px-8 py-4 bg-white text-charcoal font-bold uppercase tracking-widest hover:bg-cream hover:scale-105 transition-all duration-300 rounded-full"
        >
            Alle Fahrzeuge anzeigen
            <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg
            >
        </a>
    </div>
</section>

<style>
    .carousel-stage {
        display: flex;
        justify-content: center;
        align-items: center;
        perspective: 1200px;
        height: 480px;
        position: relative;
    }

    @media (min-width: 768px) {
        .carousel-stage {
            height: 520px;
        }
    }

    .carousel-slide {
        position: absolute;
        width: 300px;
        transition:
            transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94),
            opacity 0.6s ease;
        cursor: pointer;
        text-decoration: none;
    }

    @media (min-width: 768px) {
        .carousel-slide {
            width: 360px;
        }
    }

    .carousel-card {
        background: var(--color-charcoal);
        border: 1px solid var(--color-navy);
        overflow: hidden;
        transition:
            border-color 0.3s ease,
            box-shadow 0.3s ease;
    }

    .carousel-slide.active .carousel-card {
        border-color: rgba(159, 175, 43, 0.5); /* using orange base #9FAF2B */
        box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.6),
            0 0 20px rgba(159, 175, 43, 0.15);
    }

    .carousel-dot.active {
        width: 24px;
        background: var(--color-orange);
        border-color: var(--color-orange);
        border-radius: 4px;
    }
</style>

<script>
    const stage = document.getElementById("carousel-stage");
    const slides = document.querySelectorAll(".carousel-slide");
    const prevBtn = document.getElementById("carousel-prev");
    const nextBtn = document.getElementById("carousel-next");
    const dots = document.querySelectorAll(".carousel-dot");
    const total = slides.length;
    let current = 0;
    let autoplayTimer: ReturnType<typeof setInterval>;

    function isMobile() {
        return window.innerWidth < 768;
    }

    function updateCarousel() {
        if (!stage || slides.length === 0) return;
        const mobile = isMobile();
        const baseOffset = mobile ? 220 : 280;

        slides.forEach((slide, i) => {
            const el = slide as HTMLElement;
            let diff = i - current;

            // Wrap around for infinite feel
            if (diff > total / 2) diff -= total;
            if (diff < -total / 2) diff += total;

            const absDiff = Math.abs(diff);
            const translateX = diff * baseOffset;
            const translateZ = -absDiff * 140;
            const rotateY = diff * -12;
            const scale =
                absDiff === 0 ? 1 : Math.max(0.65, 1 - absDiff * 0.15);
            const opacity = absDiff > 2 ? 0 : Math.max(0.3, 1 - absDiff * 0.35);
            const zIndex = total - absDiff;

            el.style.transform = `translateX(${translateX}px) translateZ(${translateZ}px) rotateY(${rotateY}deg) scale(${scale})`;
            el.style.opacity = String(opacity);
            el.style.zIndex = String(zIndex);
            el.style.pointerEvents = absDiff === 0 ? "auto" : "none";

            if (absDiff === 0) {
                el.classList.add("active");
            } else {
                el.classList.remove("active");
            }
        });

        // Update dots
        dots.forEach((dot, i) => {
            if (i === current) {
                dot.classList.add("active");
            } else {
                dot.classList.remove("active");
            }
        });
    }

    function goTo(index: number) {
        current = ((index % total) + total) % total;
        updateCarousel();
    }

    function next() {
        goTo(current + 1);
    }
    function prev() {
        goTo(current - 1);
    }

    // Button clicks
    nextBtn?.addEventListener("click", () => {
        next();
        resetAutoplay();
    });
    prevBtn?.addEventListener("click", () => {
        prev();
        resetAutoplay();
    });

    // Dot clicks
    dots.forEach((dot) => {
        dot.addEventListener("click", () => {
            const idx = parseInt(dot.getAttribute("data-dot") || "0");
            goTo(idx);
            resetAutoplay();
        });
    });

    // Slide clicks (non-active slides navigate to that slide)
    slides.forEach((slide) => {
        slide.addEventListener("click", (e) => {
            const idx = parseInt(slide.getAttribute("data-index") || "0");
            if (idx !== current) {
                e.preventDefault();
                goTo(idx);
                resetAutoplay();
            }
        });
    });

    // Touch/Swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    stage?.addEventListener(
        "touchstart",
        (e) => {
            touchStartX = (e as TouchEvent).changedTouches[0].screenX;
        },
        { passive: true },
    );

    stage?.addEventListener(
        "touchend",
        (e) => {
            touchEndX = (e as TouchEvent).changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) next();
                else prev();
                resetAutoplay();
            }
        },
        { passive: true },
    );

    // Keyboard
    document.addEventListener("keydown", (e) => {
        if (!stage) return;
        const rect = stage.getBoundingClientRect();
        if (rect.top >= 0 && rect.bottom <= window.innerHeight) {
            if (e.key === "ArrowRight") {
                next();
                resetAutoplay();
            }
            if (e.key === "ArrowLeft") {
                prev();
                resetAutoplay();
            }
        }
    });

    // Autoplay
    function startAutoplay() {
        if (slides.length > 0) {
            autoplayTimer = setInterval(next, 4000);
        }
    }

    function resetAutoplay() {
        clearInterval(autoplayTimer);
        startAutoplay();
    }

    // Init
    updateCarousel();
    startAutoplay();

    // Resize handler
    window.addEventListener("resize", () => updateCarousel());
</script>
