---
import { formatPrice, formatMileage, type Car } from "../lib/inventory";

interface Props {
    car: Car;
}

const { car } = Astro.props;
---

<a
    href={`/fahrzeug/${car.id}`}
    data-title={`${car.make} ${car.model}`}
    data-category={car.category}
    class="vehicle-card group block bg-white rounded-[2rem] overflow-hidden shadow-lg border border-gray-100 transition-all duration-500 hover:shadow-orange/20 hover:shadow-2xl hover:-translate-y-2"
>
    <!-- Cinematic Carousel Container -->
    <div
        class="relative aspect-[16/10] overflow-hidden rounded-t-[2rem] group/carousel"
    >
        <div
            class="flex overflow-x-auto snap-x snap-mandatory scroll-smooth w-full h-full hide-scrollbar carousel-container"
        >
            {
                car.images.map((image, i) => (
                    <img
                        src={image}
                        alt={`${car.make} ${car.model} - Ansicht ${i + 1}`}
                        class="min-w-full h-full object-cover snap-center transition-transform duration-700 group-hover:scale-105"
                        loading={i === 0 ? "eager" : "lazy"}
                    />
                ))
            }
        </div>

        {
            car.images.length > 1 && (
                <>
                    <button
                        class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-white/80 backdrop-blur text-navy opacity-0 group-hover/carousel:opacity-100 transition-all hover:bg-white hover:scale-110 shadow-lg z-20 carousel-prev"
                        aria-label="Vorheriges Bild"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                    </button>
                    <button
                        class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-white/80 backdrop-blur text-navy opacity-0 group-hover/carousel:opacity-100 transition-all hover:bg-white hover:scale-110 shadow-lg z-20 carousel-next"
                        aria-label="NÃ¤chstes Bild"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="m9 18 6-6-6-6" />
                        </svg>
                    </button>

                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5 z-20">
                        {car.images.map((_, i) => (
                            <div
                                class={`w-1.5 h-1.5 rounded-full ${i === 0 ? "bg-white scale-125" : "bg-white/50"} shadow-sm border border-black/10 transition-all duration-300 carousel-dot`}
                            />
                        ))}
                    </div>
                </>
            )
        }

        <!-- Top Badges -->
        <div class="absolute top-4 left-4 flex gap-2 z-20 pointer-events-none">
            <span
                class="px-3 py-1 bg-navy/80 backdrop-blur-md text-white text-[10px] font-black rounded-full uppercase tracking-widest shadow-lg"
            >
                {
                    car.category === "nutz"
                        ? "Nutzfahrzeug"
                        : car.category === "pkw"
                          ? "PKW"
                          : "Quad/UTV"
                }
            </span>
        </div>
        <!-- Bottom Right Badge -->
        <div class="absolute bottom-4 right-4 z-20 pointer-events-none">
            <span
                class="px-3 py-1 bg-green-500/90 backdrop-blur-sm text-white text-[10px] font-black rounded-full uppercase shadow-lg border border-green-400/30"
                >HU/AU Neu</span
            >
        </div>

        <!-- Subtle bottom gradient for dot contrast -->
        <div
            class="absolute bottom-0 left-0 w-full h-1/3 bg-gradient-to-t from-black/20 to-transparent pointer-events-none z-10"
        >
        </div>
    </div>

    <div class="p-6">
        <div class="mb-4">
            <h3
                class="text-xl font-black text-navy uppercase tracking-tight group-hover:text-orange transition-colors"
            >
                {car.make}
                <span class="font-normal text-gray-500">{car.model}</span>
            </h3>
        </div>

        <div class="grid grid-cols-2 gap-y-3 gap-x-4 mb-6">
            <div class="flex items-center gap-2 text-gray-500 text-xs">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-orange"
                    ><path
                        d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-1.1 0-2 .9-2 2v7c0 1.1.9 2 2 2h2"
                    ></path><circle cx="7" cy="17" r="2"></circle><path
                        d="M9 17h6"></path><circle cx="17" cy="17" r="2"
                    ></circle></svg
                >
                {formatMileage(car.mileage)}
            </div>
            <div class="flex items-center gap-2 text-gray-500 text-xs">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-orange"
                    ><rect width="18" height="18" x="3" y="4" rx="2" ry="2"
                    ></rect><line x1="16" x2="16" y1="2" y2="6"></line><line
                        x1="8"
                        x2="8"
                        y1="2"
                        y2="6"></line><line x1="3" x2="21" y1="10" y2="10"
                    ></line></svg
                >
                {car.firstRegistration}
            </div>
            <div class="flex items-center gap-2 text-gray-500 text-xs">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-orange"
                    ><path d="M12 2v20"></path><path d="m4.93 4.93 14.14 14.14"
                    ></path><path d="M2 12h20"></path><path
                        d="m19.07 4.93-14.14 14.14"></path></svg
                >
                {car.power}
                {car.powerUnit}
            </div>
            <div class="flex items-center gap-2 text-gray-500 text-xs">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-orange"
                    ><path d="M3 12h18"></path><path d="M3 7h18"></path><path
                        d="M3 17h18"></path></svg
                >
                {car.transmission}
            </div>
        </div>

        <div
            class="flex items-center justify-between pt-4 border-t border-gray-100"
        >
            <span class="text-2xl font-black text-navy"
                >{formatPrice(car.price)}</span
            >
            <div class="text-orange">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><line x1="5" y1="12" x2="19" y2="12"></line><polyline
                        points="12 5 19 12 12 19"></polyline></svg
                >
            </div>
        </div>
    </div>
</a>

<script>
    function initCarousels() {
        document.querySelectorAll(".vehicle-card").forEach((card) => {
            const container = card.querySelector(".carousel-container");
            const prevBtn = card.querySelector(".carousel-prev");
            const nextBtn = card.querySelector(".carousel-next");
            const dots = card.querySelectorAll(".carousel-dot");

            if (!container || !prevBtn || !nextBtn) return;

            let isScrolling = false;

            const scrollByImage = (direction) => {
                const width = container.clientWidth;
                container.scrollBy({
                    left: direction * width,
                    behavior: "smooth",
                });
            };

            prevBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                scrollByImage(-1);
            });

            nextBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                scrollByImage(1);
            });

            container.addEventListener(
                "scroll",
                () => {
                    if (!isScrolling) {
                        window.requestAnimationFrame(() => {
                            const index = Math.round(
                                container.scrollLeft / container.clientWidth,
                            );
                            dots.forEach((dot, i) => {
                                if (i === index) {
                                    dot.classList.remove("bg-white/50");
                                    dot.classList.add("bg-white", "scale-125");
                                } else {
                                    dot.classList.add("bg-white/50");
                                    dot.classList.remove(
                                        "bg-white",
                                        "scale-125",
                                    );
                                }
                            });
                            isScrolling = false;
                        });
                        isScrolling = true;
                    }
                },
                { passive: true },
            );
        });
    }

    // Run on initial load (and after Astro transitions if enabled)
    initCarousels();
    document.addEventListener("astro:page-load", initCarousels);
</script>

<style>
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
